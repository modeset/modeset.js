<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>perlin noise practice - js do it</title>
<meta name="Description" content="" />
<meta name="Keywords"  content="" />

<link rel="stylesheet" type="text/css" media="screen,print" href="style.css" />
</head>
<body>
<!-- generated by: jsdo.it - http://jsdo.it/gct256/PerlinNoise_old -->
<!-- Copyright gct256 - http://jsdo.it/gct256 -->
<!-- Licensed under MIT License - http://www.opensource.org/licenses/mit-license.php -->
<div><canvas id="canvas" width="256" height="256"></canvas></div>

<p id="detail">-</p>

<script type="text/javascript"><!--
function redraw(pn, d, clear) {
  var canvas = document.getElementById('canvas');
  var context = canvas.getContext('2d');
  var w = canvas.width;
  var h = canvas.height, h2 = h >> 1;

  if (clear) context.clearRect(0, 0, w, h);
  context.strokeStyle = 'rgba(127,127,255,0.5)';
  var v = pn.perlinNoise(0, 0, d);
  context.beginPath();
  context.moveTo(0, v * h2 + h2);
  for (var x = 0; x < w; ++x) {
    v = pn.perlinNoise(x / w, 0, d);
    context.lineTo(x, v * h2 + h2);
  }
  context.stroke();
}
window.addEventListener('load', function() {
  var d = 1;
  var detail = document.getElementById('detail');
  var pn = new PerlinNoise;
  setInterval(function() {
    detail.innerHTML = 'detail: ' + d;
    redraw(pn, d, d == 1);
    if (d++ == 15) {
      d = 1;
      pn = new PerlinNoise();
    }
  }, 50);
}, false)
//--></script>



<script type="text/javascript">
// ??????????????
// ???XorShift
// ?????????????????????

var pseudoRandom = (function() {
  var X_BASE = 123456789, Y_BASE = 362436069, Z_BASE = 521288629,
      nn = function(v) {
        return isFinite(v = +v) ? v : 0;
      },
      ii = function(v) {
        return isFinite(v = parseInt(v, 10)) ? v : 0;
      },
      ex = function(x,y,z) {
        if (x != null && y != null) for (z in y) x[z] = y[z];
      },
      klass = function() {
        this.reset();
      },
      getSeed = function(v) {
        return (1812433253 * (v ^ (v << 30))) >>> 0;
      },
      global;

  ex(klass, {
    reset: function(seed) {
      if (arguments.length == 0) global.reset();
      else global.reset(seed);
    },
    generate: function() {
      return global.generate();
    },
    i:function(a, b) {
      switch (arguments.length) {
        case 0: return global.i();
        case 1: return global.i(a);
        default: return global.i(a, b);
      }
    },
    f:function(a, b) {
      switch (arguments.length) {
        case 0: return global.f();
        case 1: return global.f(a);
        default: return global.f(a, b);
      }
    }
  });
  ex(klass.prototype, {
    reset: function(seed) {
      this.x = X_BASE;
      this.y = Y_BASE;
      this.z = Z_BASE;
      if (arguments.length == 0) {
        this.w = getSeed(Math.random() * 0x100000000);
      } else {
        this.w = getSeed(seed);
      }
    },
    generate: function() {
      var t = this.x ^ this.x << 11, w = this.w;
      this.x = this.y;
      this.y = this.z;
      this.z = w;
      return this.w = ((w ^ (w >>> 19)) ^ (t ^ (t >>> 8))) >>> 0;
    },
    i: function(a, b) {
      var c;
      switch (arguments.length) {
      case 0:
        return this.generate();
      case 1:
        a = Math.floor(ii(a));
        return Math.floor(this.generate() / 0x100000000 * a);
      case 2:
        a = Math.floor(ii(a));
        b = Math.floor(ii(b));
        if (a > b) { c = a; a = b; b = c; }
        return Math.floor(this.generate() / 0x100000000 * (b - a + 1) + a);
      }
      return 0;
    },
    f: function(a, b) {
      var c;
      switch (arguments.length) {
      case 0:
        return this.generate() / 0x100000000;
      case 1:
        return this.generate() / 0xffffffff * nn(a);
      case 2:
        a = nn(a);
        b = nn(b);
        if (a > b) { c = a; a = b; b = c; }
        return this.generate() / 0x100000000 * (b - a) + a;
      }
      return 0;
    }
  });
  global = new klass;
  return klass;
})();


</script>

<script>
// perlin noise object
// based on http://www.programmersheaven.com/2/perlin
// require my pseudoRandom library
//   http://jsdo.it/gct256/pseudoRandom

// generate object
// seed: [optional] seed for pseudoRandom (0-0xffffffff)
// persistence: [optional] (0.1-0.5?)
var PerlinNoise = function(seed, persistence) {
  var R = new pseudoRandom();
  var S = this.TABLE_SIZE = (1 << 8);
  var PT = this.PERM_TABLE = [];
  var GT = this.GRAD_TABLE = [];

  if (isFinite(+seed)) R.reset(+seed); else R.reset();

  this.persistence = +persistence;
  if (!isFinite(this.persistence)) this.persistence = 0.5;

  for (var x, y, k, j, i = 0; i < S; ++i) {
    PT[i] = i;
    GT[i] = [Math.cos(j = R.f(6.283185307179586)), Math.sin(j)];
  }
  while (i > 0) {
    j = R.i(i);
    k = PT[--i];
    PT[i] = PT[j];
    PT[j] = k;
  }
};

// generate noise (internal?)
PerlinNoise.prototype.noise = function(x, y) {
  var PT = this.PERM_TABLE, GT = this.GRAD_TABLE, S = this.TABLE_SIZE - 1;

  var px = Math.floor(x), gx = x - px;
  var py = Math.floor(y), gy = y - py;

  var aa = GT[PT[(py +     PT[(px    ) & S]) & S]];
  var ab = GT[PT[(py +     PT[(px + 1) & S]) & S]];
  var ba = GT[PT[(py + 1 + PT[(px    ) & S]) & S]];
  var bb = GT[PT[(py + 1 + PT[(px + 1) & S]) & S]];

  var vv = aa[0] * (gx    ) + aa[1] * (gy    );
  var vw = ab[0] * (gx - 1) + ab[1] * (gy    );
  var wv = ba[0] * (gx    ) + ba[1] * (gy - 1);
  var ww = bb[0] * (gx - 1) + bb[1] * (gy - 1);

  var t = (3 - 2 * gx) * gx * gx;
  var v0 = vv - t * (vv - vw);
  var v1 = wv - t * (wv - ww);
  return v0 - ((3 - 2 * gy) * gy * gy) * (v0 - v1);
};

// genereate perlin noise
// x: 0..1
// y: 0..1
// detail: 1.. (recommend: 1..8)
PerlinNoise.prototype.perlinNoise = function(x, y, detail) {
  for (var n = 0, p = this.persistence, q = 1, i = 0, s = 1; i < detail; ++i, s *= 2, q *= p)
    n += this.noise(x * s, y * s) * q;
  return n;
};

</script>
</body>
</html>
